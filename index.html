<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.2/firebase-app.js";
    import { getDatabase, ref, set, onValue, push } from "https://www.gstatic.com/firebasejs/10.7.2/firebase-database.js";

    // Configuración de Firebase
    const firebaseConfig = {
        apiKey: "AIzaSyA4ZOaSkduTmMNmMQ-B1UtCDJtSK7JU9hA",
        authDomain: "fiestas-a5462.firebaseapp.com",
        databaseURL: "https://fiestas-a5462-default-rtdb.firebaseio.com",
        projectId: "fiestas-a5462",
        storageBucket: "fiestas-a5462.appspot.com",
        messagingSenderId: "772543336072",
        appId: "1:772543336072:web:b88c7f08a89f1dd3dcd93d"
    };

    // Inicializar Firebase
    const app = initializeApp(firebaseConfig);
    const database = getDatabase(app);

    // Referencias en Firebase
    const depositosRef = ref(database, "depositos");
    const totalRef = ref(database, "totalMonto");

    // Obtener elementos del DOM
    const depositForm = document.getElementById("deposit-form");
    const amountInput = document.getElementById("amount");
    const nameInput = document.getElementById("name");
    const totalAmountSpan = document.getElementById("total-amount");
    const historyList = document.getElementById("history-list");

    // ✅ Recuperar y mostrar el monto total desde Firebase
    onValue(totalRef, (snapshot) => {
        if (snapshot.exists()) {
            totalAmountSpan.textContent = `$${snapshot.val()}`;
        } else {
            totalAmountSpan.textContent = "$0";  // Si Firebase no tiene monto, empieza en 0
        }
    });

    // ✅ Cargar los depósitos desde Firebase
    onValue(depositosRef, (snapshot) => {
        historyList.innerHTML = "";  // Limpiar lista antes de actualizar
        if (snapshot.exists()) {
            snapshot.forEach((childSnapshot) => {
                const deposito = childSnapshot.val();
                const listItem = document.createElement("li");
                listItem.textContent = `${deposito.nombre} depositó $${deposito.cantidad} el ${deposito.fecha}`;
                historyList.appendChild(listItem);
            });
        } else {
            historyList.innerHTML = "<li>No hay depósitos registrados aún.</li>";
        }
    });

    // ✅ Función para agregar un nuevo depósito a Firebase
    function agregarDeposito(nombre, cantidad) {
        push(depositosRef, { nombre, cantidad, fecha: new Date().toLocaleString() });

        // Actualizar el monto total en Firebase sumando el nuevo depósito
        onValue(totalRef, (snapshot) => {
            let total = snapshot.exists() ? snapshot.val() : 0;
            set(totalRef, total + cantidad);
        });
    }

    // ✅ Manejo del formulario para agregar depósitos
    depositForm.addEventListener("submit", (event) => {
        event.preventDefault();
        const nombre = nameInput.value.trim();
        const cantidad = parseInt(amountInput.value);

        if (!nombre || isNaN(cantidad) || cantidad <= 0) {
            alert("Por favor, ingresa un nombre y un monto válido.");
            return;
        }

        agregarDeposito(nombre, cantidad);

        // Limpiar los campos
        nameInput.value = "";
        amountInput.value = "";
    });

</script>